{% extends "base.html" %}
{% block title %}Language Coach â€” Home{% endblock %}
{% block body_class %}dashboard-page{% endblock %}

{% block content %}
{% set fr = stats.get('french') %}
{% set es = stats.get('spanish') %}
<!-- Hero -->
<section class="hero-section">
  <div class="container">
    <div class="row align-items-start py-4 g-4">
      <div class="col-lg-6">
        <h1 class="hero-title">
          <span class="hero-bubble bengali-text">à¦†à¦ªà¦¨à¦¾à¦•à§‡</span>
          <span class="hero-bubble hero-bubble-alt bengali-text">à¦¸à§à¦¬à¦¾à¦—à¦¤à¦®!</span>
          <span class="wave">ğŸ‘‹</span>
        </h1>
        <p class="hero-subtitle">Learn <strong>French</strong> &amp; <strong>Spanish</strong> through <strong>Bengali</strong> and <strong>English</strong></p>
        <p class="hero-desc text-muted">
          à¦«à¦°à¦¾à¦¸à¦¿ à¦“ à¦¸à§à¦ªà§à¦¯à¦¾à¦¨à¦¿à¦¶ à¦¶à¦¿à¦–à§à¦¨ à¦¬à¦¾à¦‚à¦²à¦¾ à¦“ à¦‡à¦‚à¦°à§‡à¦œà¦¿à¦° à¦®à¦¾à¦§à§à¦¯à¦®à§‡ â€” à¦§à¦¾à¦ªà§‡ à¦§à¦¾à¦ªà§‡, à¦‡à¦¨à§à¦Ÿà¦¾à¦°à§‡à¦•à§à¦Ÿà¦¿à¦­ à¦ªà¦¦à§à¦§à¦¤à¦¿à¦¤à§‡à¥¤
        </p>
        {% if activity %}
        <div class="d-flex gap-2 flex-wrap mt-3">
          <span class="badge rounded-pill bg-light text-dark">
            ğŸ”¥ Streak: {{ activity.streak_days }} day{% if activity.streak_days != 1 %}s{% endif %}
          </span>
          <span class="badge rounded-pill bg-light text-dark">
            â­ XP Today: {{ activity.xp_today }}
          </span>
          <span class="badge rounded-pill bg-light text-dark">
            ğŸƒ Reviews Today: {{ activity.reviews_today }}
          </span>
        </div>
        {% endif %}
        <div class="d-flex gap-3 flex-wrap mt-4">
          <a href="{{ fr.continue_url if fr else url_for('language_home', lang='french') }}" class="btn btn-french btn-lg">
            {% if fr and fr.completed > 0 %}â–¶ Continue French{% else %}ğŸ‡«ğŸ‡· Start French{% endif %}
          </a>
          <a href="{{ es.continue_url if es else url_for('language_home', lang='spanish') }}" class="btn btn-spanish btn-lg">
            {% if es and es.completed > 0 %}â–¶ Continue Spanish{% else %}ğŸ‡ªğŸ‡¸ Start Spanish{% endif %}
          </a>
        </div>
        {% if (fr and fr.completed > 0) or (es and es.completed > 0) %}
        <div class="d-flex gap-2 flex-wrap mt-3">
          {% if fr and fr.completed > 0 %}
          <a href="{{ url_for('review', lang='french') }}" class="btn btn-outline-secondary btn-sm">
            ğŸ” Review French (SRS)
          </a>
          {% endif %}
          {% if es and es.completed > 0 %}
          <a href="{{ url_for('review', lang='spanish') }}" class="btn btn-outline-secondary btn-sm">
            ğŸ” Review Spanish (SRS)
          </a>
          {% endif %}
          <a href="{{ url_for('practice', lang='french' if (fr and fr.completed > 0) else 'spanish') }}" class="btn btn-outline-secondary btn-sm">
            âš¡ Daily Practice
          </a>
        </div>
        {% endif %}
      </div>

      <div class="col-lg-6">
        <div class="card hero-glass hero-dict-card">
          <div class="card-body p-3 p-md-4">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
              <div class="fw-semibold">
                <i class="fas fa-magnifying-glass me-2"></i> Translate &amp; Listen
              </div>
              <div class="d-flex align-items-center gap-2">
                <div class="small text-muted">From</div>
                <select id="heroDictSource" class="form-select form-select-sm hero-glass-select" aria-label="Source language">
                  <option value="auto" selected>Auto</option>
                  <option value="en">English</option>
                  <option value="fr">FranÃ§ais</option>
                  <option value="es">EspaÃ±ol</option>
                  <option value="bn">à¦¬à¦¾à¦‚à¦²à¦¾</option>
                </select>
              </div>
            </div>

            <div class="input-group mt-3">
              <input id="heroDictText" type="text" class="form-control"
                     placeholder="Type a word (English / FranÃ§ais / EspaÃ±ol / à¦¬à¦¾à¦‚à¦²à¦¾)â€¦ (then press Enter)">
              <button id="heroDictSearch" class="btn btn-primary" type="button">
                <i class="fas fa-search me-1"></i> Search
              </button>
            </div>

            <div class="d-flex gap-2 flex-wrap mt-3">
              <button type="button" class="btn btn-sm btn-outline-primary hero-dict-sample" data-text="hello">Hello</button>
              <button type="button" class="btn btn-sm btn-outline-primary hero-dict-sample" data-text="bonjour">Bonjour</button>
              <button type="button" class="btn btn-sm btn-outline-primary hero-dict-sample" data-text="hola">Hola</button>
              <button type="button" class="btn btn-sm btn-outline-primary hero-dict-sample" data-text="à¦¹à§à¦¯à¦¾à¦²à§‹">à¦¹à§à¦¯à¦¾à¦²à§‹</button>
            </div>

            <div id="heroDictStatus" class="small text-muted mt-2"></div>
            <div id="heroDictResults" class="mt-3"></div>

            <div class="small text-muted mt-3">
              Tip: Pronunciation uses <strong>Server</strong> voice (best accent).
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Progress Cards -->
<section class="py-5 bg-light">
  <div class="container">
    <h2 class="section-title text-center mb-4">à¦†à¦ªà¦¨à¦¾à¦° à¦…à¦—à§à¦°à¦—à¦¤à¦¿ â€” <span class="title-pill">Your Progress</span></h2>
    <div class="row g-4">
      {% for lang, s in stats.items() %}
      {% set meta = lang_meta[lang] %}
      <div class="col-md-6">
        <div class="progress-card card shadow-sm h-100">
          <div class="card-body p-4">
            <div class="d-flex align-items-center gap-3 mb-3">
              <span class="lang-flag">{{ meta.flag }}</span>
              <div>
                <h3 class="mb-0 fw-bold">{{ meta.name }}</h3>
                <small class="text-muted">{{ meta.name_bn }}</small>
              </div>
              <div class="ms-auto">
                <span class="badge bg-{{ 'french-badge' if lang == 'french' else 'spanish-badge' }} fs-6">
                  {{ s.completed }}/{{ s.total }}
                </span>
              </div>
            </div>
            <div class="progress mb-3" style="height:12px">
              <div class="progress-bar bg-{{ 'french' if lang == 'french' else 'spanish' }}"
                   style="width:{{ s.percent }}%">{{ s.percent }}%</div>
            </div>
            <p class="text-muted small mb-3">
              {{ s.completed }} lessons completed out of {{ s.total }} total
              <br>{{ s.completed }} à¦Ÿà¦¿ à¦ªà¦¾à¦  à¦¸à¦®à§à¦ªà¦¨à§à¦¨, à¦®à§‹à¦Ÿ {{ s.total }} à¦Ÿà¦¿
            </p>
            {% if s.next_lesson %}
            <div class="small text-muted mb-3">
              Next: Lesson {{ s.next_lesson.id }} â€” {{ s.next_lesson.title_en }}
            </div>
            {% endif %}

            {% if s.resource %}
            <div class="small text-muted mb-3">
              Personal corpus: {{ s.resource.sentence_count }} sentence{% if s.resource.sentence_count != 1 %}s{% endif %}{% if s.resource.coverage_pct %} â€¢ coverage {{ s.resource.coverage_pct }}%{% endif %}
              {% if s.resource.top_categories and s.resource.top_categories|length %}
              <br>Focus: {% for c in s.resource.top_categories %}{{ c.label }}{% if not loop.last %}, {% endif %}{% endfor %}
              {% endif %}
              {% if s.resource.focus_lesson %}
              <br>Suggested: <a href="{{ url_for('lesson_view', lang=lang, lesson_id=s.resource.focus_lesson.id) }}" class="text-decoration-none">Lesson {{ s.resource.focus_lesson.id }} â€” {{ s.resource.focus_lesson.title_en }}</a>
              {% endif %}
            </div>
            {% endif %}
            <div class="d-grid gap-2">
              <a href="{{ s.continue_url }}" class="btn btn-{{ 'french' if lang == 'french' else 'spanish' }} w-100">
                {% if s.next_lesson %}â–¶ Continue Lesson {{ s.next_lesson.id }}{% else %}â–¶ View Lessons{% endif %}
              </a>
              <div class="d-flex gap-2">
                <a href="{{ url_for('practice', lang=lang) }}" class="btn btn-outline-{{ 'french' if lang == 'french' else 'spanish' }} btn-sm w-100">
                  âš¡ Practice
                </a>
                <a href="{{ url_for('review_flashcards', lang=lang) }}" class="btn btn-outline-secondary btn-sm w-100">
                  ğŸƒ Review
                </a>
              </div>
              {% if s.resource %}
              <a href="{{ url_for('practice', lang=lang, mode='resources') }}" class="btn btn-outline-{{ 'french' if lang == 'french' else 'spanish' }} btn-sm w-100">
                ğŸ“š Resource Drill
              </a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</section>

<!-- Features -->
<section class="py-5">
  <div class="container">
    <h2 class="section-title text-center mb-5">à¦•à§€à¦­à¦¾à¦¬à§‡ à¦¶à¦¿à¦–à¦¬à§‡à¦¨ â€” <span class="title-pill title-pill-alt">How You Learn</span></h2>
    <div class="row g-4 text-center">
      <div class="col-md-3 col-6">
        <div class="feature-card p-3">
          <div class="feature-icon">ğŸ“–</div>
          <h5 class="mt-3">Vocabulary<br><small class="text-muted">à¦¶à¦¬à§à¦¦à¦­à¦¾à¦¨à§à¦¡à¦¾à¦°</small></h5>
          <p class="small text-muted">Words with Bengali, English &amp; pronunciation</p>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="feature-card p-3">
          <div class="feature-icon">ğŸƒ</div>
          <h5 class="mt-3">Flashcards<br><small class="text-muted">à¦«à§à¦²à§à¦¯à¦¾à¦¶à¦•à¦¾à¦°à§à¦¡</small></h5>
          <p class="small text-muted">Interactive flip cards for memorization</p>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="feature-card p-3">
          <div class="feature-icon">ğŸ§ </div>
          <h5 class="mt-3">Quizzes<br><small class="text-muted">à¦•à§à¦‡à¦œ</small></h5>
          <p class="small text-muted">Test yourself with multiple-choice questions</p>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="feature-card p-3">
          <div class="feature-icon">ğŸ“</div>
          <h5 class="mt-3">Grammar<br><small class="text-muted">à¦¬à§à¦¯à¦¾à¦•à¦°à¦£</small></h5>
          <p class="small text-muted">Articles, tenses explained in Bengali</p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- CEFR Learning Path -->
<section class="py-5 bg-light">
  <div class="container">
    <h2 class="section-title text-center mb-2">CEFR à¦¶à¦¿à¦•à§à¦·à¦¾à¦° à¦ªà¦¥ â€” <span class="title-pill title-pill-lime">Learning Roadmap</span></h2>
    <p class="text-center text-muted mb-5 small">Aligned with DELF (French) &amp; DELE (Spanish) international exams â€¢ counts are per language</p>
    <div class="row g-3">
      {% set cefr_steps = [
        ('A1', 'cefr-A1', 'ğŸŸ¢', 'Elementary', 'à¦ªà§à¦°à¦¾à¦¥à¦®à¦¿à¦•', 'Alphabet Â· Greetings Â· Numbers Â· Colors Â· Family Â· Body Â· Food Â· Nationalities Â· Daily Routine Â· Hobbies', 'DELF A1 / DELE A1'),
        ('A2', 'cefr-A2', 'ğŸ”µ', 'Pre-intermediate', 'à¦ªà§à¦°à¦¿-à¦‡à¦¨à§à¦Ÿà¦¾à¦°à¦®à¦¿à¦¡à¦¿à¦¯à¦¼à§‡à¦Ÿ', 'Past & Future Tenses Â· Health Â· Home Â· Sports Â· Work Â· Shopping Â· Emotions Â· Travel', 'DELF A2 / DELE A2'),
        ('B1', 'cefr-B1', 'ğŸŸ ', 'Intermediate', 'à¦®à¦§à§à¦¯à¦¬à¦°à§à¦¤à§€', 'Complex vocabulary Â· Idioms Â· Culture Â· Narrative fluency Â· Opinions', 'DELF B1 / DELE B1'),
        ('B2', 'cefr-B2', 'ğŸ”´', 'Upper Intermediate', 'à¦‰à¦ªà¦°à§‡à¦° à¦®à¦§à§à¦¯à¦¬à¦°à§à¦¤à§€', 'Debate Â· Professional contexts Â· Nuanced expression Â· Abstract topics', 'DELF B2 / DELE B2')
      ] %}
      {% for lvl, badge_cls, icon, name, name_bn, topics, exam in cefr_steps %}
      {% set count = (cefr_counts.get(lvl, 0) if cefr_counts is defined else 0) %}
      <div class="col-md-6 col-lg-3">
        <div class="path-card p-4 text-center h-100">
          <div class="path-icon">{{ icon }}</div>
          <div class="mt-2 mb-1">
            <span class="badge {{ badge_cls }} fs-5 px-3 py-2">{{ lvl }}</span>
          </div>
          <h5 class="mt-2 mb-0">{{ name }}</h5>
          <small class="text-muted d-block mb-2">{{ name_bn }}</small>
          <p class="small text-muted mt-2 mb-2">{{ topics }}</p>
          <div class="mt-auto pt-2">
            <span class="badge bg-light text-dark border small d-block mb-1">{{ exam }}</span>
            <span class="badge bg-secondary-subtle text-secondary small">
              {% if count %}{{ count }} lessons{% else %}Coming soon{% endif %}
            </span>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
(() => {
  const elText = document.getElementById('heroDictText');
  const elSearch = document.getElementById('heroDictSearch');
  const elSource = document.getElementById('heroDictSource');
  const elStatus = document.getElementById('heroDictStatus');
  const elResults = document.getElementById('heroDictResults');
  const sampleButtons = Array.from(document.querySelectorAll('.hero-dict-sample[data-text]'));

  if (!elText || !elSearch || !elSource || !elResults) return;

  function setStatus(text) {
    if (!elStatus) return;
    elStatus.textContent = text || '';
  }

  function ttsMeta(code) {
    if (code === 'en') return {name: 'English', tag: 'en-US'};
    if (code === 'fr') return {name: 'FranÃ§ais', tag: 'fr-FR'};
    if (code === 'es') return {name: 'EspaÃ±ol', tag: 'es-ES'};
    if (code === 'bn') return {name: 'à¦¬à¦¾à¦‚à¦²à¦¾', tag: 'bn-BD'};
    return {name: code || 'Language', tag: ''};
  }

  function renderResults(data) {
    elResults.innerHTML = '';

    const order = ['en', 'fr', 'es', 'bn'];
    const results = (data && data.results) ? data.results : {};
    const detected = (data && data.source) ? String(data.source) : '';

    const grid = document.createElement('div');
    grid.className = 'row g-2';

    let shown = 0;
    order.forEach(code => {
      const item = results[code];
      const text = item && item.text ? String(item.text).trim() : '';
      if (!text) return;

      const meta = ttsMeta(code);
      const col = document.createElement('div');
      col.className = 'col-12 col-md-6';

      const card = document.createElement('div');
      card.className = 'hero-dict-result p-2 px-3';

      const top = document.createElement('div');
      top.className = 'd-flex align-items-center justify-content-between gap-2';

      const left = document.createElement('div');
      const lbl = document.createElement('div');
      lbl.className = 'small text-muted';
      lbl.textContent = meta.name + (detected === code ? ' (detected)' : '');

      const val = document.createElement('div');
      val.className = 'fw-semibold';
      val.textContent = text;
      left.appendChild(lbl);
      left.appendChild(val);

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-sm btn-outline-primary';
      btn.title = 'Listen';
      btn.innerHTML = '<i class=\"fas fa-volume-up\"></i>';
      btn.addEventListener('click', () => {
        if (typeof speakText !== 'function') return;
        speakText(text, meta.tag || (item.lang_tag || ''));
      });

      top.appendChild(left);
      top.appendChild(btn);
      card.appendChild(top);
      col.appendChild(card);
      grid.appendChild(col);
      shown++;
    });

    if (!shown) {
      const empty = document.createElement('div');
      empty.className = 'small text-muted';
      empty.textContent = 'No matches found.';
      elResults.appendChild(empty);
      return;
    }
    elResults.appendChild(grid);
  }

  async function runLookup() {
    const q = (elText.value || '').trim();
    if (!q) return;

    setStatus('Searchingâ€¦');
    elResults.innerHTML = '';

    let res;
    let data;
    try {
      res = await fetch('/api/translate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({text: q, source: elSource.value || 'auto'})
      });
    } catch {
      setStatus('Network error.');
      return;
    }

    try {
      data = await res.json();
    } catch {
      setStatus('Unexpected server response.');
      return;
    }

    if (!res.ok || !data || !data.ok) {
      setStatus((data && data.error) ? String(data.error) : 'Lookup failed.');
      return;
    }

    const provider = data.provider ? ` â€¢ ${data.provider}` : '';
    const detected = data.source ? `Detected: ${String(data.source).toUpperCase()}` : '';
    setStatus(`${detected}${provider}`.trim());
    renderResults(data);
  }

  elSearch.addEventListener('click', runLookup);
  elText.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      runLookup();
    }
  });

  sampleButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      elText.value = btn.dataset.text || '';
      runLookup();
    });
  });
})();
</script>
{% endblock %}
