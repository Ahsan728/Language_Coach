{% extends "base.html" %}
{% block title %}{{ lesson.title_en }} ‚Äî Language Coach{% endblock %}
{% block body_class %}lang-{{ lang }}-page lesson-page{% endblock %}

{% block content %}
<!-- Lesson Header -->
<div class="lang-header lang-header-{{ lang }} py-4">
  <div class="container">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-2">
        <li class="breadcrumb-item"><a href="/" class="text-white opacity-75">Home</a></li>
        <li class="breadcrumb-item"><a href="/language/{{ lang }}" class="text-white opacity-75">{{ meta.flag }} {{ meta.name }}</a></li>
        <li class="breadcrumb-item active text-white">Lesson {{ lesson.id }}</li>
      </ol>
    </nav>
    <div class="d-flex align-items-center gap-3">
      <span style="font-size:2.5rem">{{ lesson.icon }}</span>
      <div>
        <h1 class="fw-bold text-white mb-0">{{ lesson.title_en }}</h1>
        <p class="text-white opacity-75 mb-0">{{ lesson.title_bn }} &bull; {{ lesson.title_lang }}</p>
      </div>
    </div>
  </div>
</div>

<div class="container py-4">
  <div class="row">
    <!-- Main content -->
    <div class="col-lg-8">

      <!-- Description card -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
          <p class="mb-1">{{ lesson.description_en }}</p>
          <p class="text-muted mb-0 bengali-text">{{ lesson.description_bn }}</p>
        </div>
      </div>

      <!-- Tip box -->
      {% if lesson.get('tip_en') %}
      <div class="tip-box mb-4">
        <div class="tip-icon">üí°</div>
        <div>
          <strong>Pro Tip:</strong> {{ lesson.tip_en }}
          <div class="mt-1 text-muted small bengali-text">{{ lesson.tip_bn }}</div>
        </div>
      </div>
      {% endif %}

      <!-- ========== VOCABULARY SECTION ========== -->
      {% if vocabulary %}
      <h3 class="section-label mb-3">
        <i class="fas fa-book-open me-2 text-{{ 'french' if lang == 'french' else 'spanish' }}"></i>
        Vocabulary ‚Äî ‡¶∂‡¶¨‡ßç‡¶¶‡¶≠‡¶æ‡¶®‡ßç‡¶°‡¶æ‡¶∞
      </h3>
      <div class="row g-2 align-items-center mb-3">
        <div class="col-md-8">
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input id="vocabSearchInput" type="search" class="form-control"
                   placeholder="Search vocabulary (word / English / ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)‚Ä¶"
                   oninput="filterLessonVocab()">
          </div>
        </div>
        <div class="col-md-4 text-md-end">
          <small class="text-muted" id="vocabSearchCount"></small>
        </div>
      </div>
      <div class="row g-3 mb-4">
        {% for word in vocabulary %}
        <div class="col-md-6" data-vocab-item="1"
             data-vocab-search="{{ (word.article + ' ') if word.article else '' }}{{ word.word }} {{ word.english }} {{ word.bengali }} {{ word.pronunciation or '' }}">
          <div class="vocab-card card border-0 shadow-sm h-100">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between align-items-start">
                {% set tts_word = (word.article + ('' if word.article.endswith("'") else ' ') + word.word) if word.article else word.word %}
                <div class="vocab-word fw-bold fs-5 text-{{ 'french' if lang == 'french' else 'spanish' }}">
                  {% if word.article %}<span class="vocab-article">{{ word.article }}</span>{% if not word.article.endswith("'") %} {% endif %}{% endif %}{{ word.word }}
                </div>
                <div class="d-flex align-items-center gap-2">
                  <button class="btn btn-sm btn-light border btn-listen" type="button"
                          data-tts="{{ tts_word }}"
                          data-lang="{{ 'fr-FR' if lang == 'french' else 'es-ES' }}"
                          title="Listen">
                    <i class="fas fa-volume-up"></i>
                  </button>
                  {% if word.pronunciation %}
                  <span class="pron-badge">{{ word.pronunciation }}</span>
                  {% endif %}
                </div>
              </div>
              <div class="vocab-english mt-1">üá¨üáß {{ word.english }}</div>
              <div class="vocab-bengali bengali-text mt-1">üáßüá© {{ word.bengali }}</div>
              {% if word.get('example') %}
              <div class="example-box mt-2">
                <div class="example-lang">{{ meta.flag }} <em>{{ word.example }}</em></div>
                <div class="example-en">üá¨üáß {{ word.example_en }}</div>
                <div class="example-bn bengali-text">üáßüá© {{ word.example_bn }}</div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- ========== GRAMMAR SECTION ========== -->
      {% if grammar %}
      <h3 class="section-label mb-3">
        <i class="fas fa-graduation-cap me-2 text-{{ 'french' if lang == 'french' else 'spanish' }}"></i>
        Grammar ‚Äî ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶∞‡¶£
      </h3>

      <!-- Grammar intro -->
      <div class="grammar-intro card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
          <p class="mb-2">{{ grammar.intro_en }}</p>
          <p class="bengali-text text-muted mb-0">{{ grammar.intro_bn }}</p>
        </div>
      </div>

      <!-- Grammar sections -->
      {% for section in grammar.sections %}
      <div class="grammar-section card border-0 shadow-sm mb-4">
        <div class="card-header grammar-section-header">
          <h5 class="mb-0 fw-semibold">{{ section.title_en }}</h5>
          <small class="bengali-text text-muted">{{ section.title_bn }}</small>
        </div>
        <div class="card-body p-0">
          {% if section.get('table') %}
          <div class="table-responsive">
            <table class="table grammar-table mb-0">
              {% for row in section.table %}
              <tr class="{% if loop.first %}table-header-row{% endif %}">
                {% for cell in row %}
                <{% if loop.first and not loop.last or (loop.index == 1 and not loop.last) %}th{% else %}td{% endif %} class="{% if loop.first %}fw-semibold{% endif %} {% if '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ' in cell or loop.index == 4 %}bengali-text{% endif %}">
                  {{ cell }}
                </{% if loop.first and not loop.last or (loop.index == 1 and not loop.last) %}th{% else %}td{% endif %}>
                {% endfor %}
              </tr>
              {% endfor %}
            </table>
          </div>
          {% endif %}
          <div class="p-4">
            <div class="note-box">
              <strong>üìå Note:</strong> {{ section.note_en }}
              <div class="mt-2 bengali-text text-muted">{{ section.note_bn }}</div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
      {% endif %}

    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <div class="sidebar sticky-top" style="top:80px">

        <!-- Practice buttons -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header fw-semibold">
            <i class="fas fa-dumbbell me-2"></i> Practice ‚Äî ‡¶Ö‡¶≠‡ßç‡¶Ø‡¶æ‡¶∏
          </div>
          <div class="card-body p-3 d-grid gap-2">
            {% if vocabulary %}
            <a href="/flashcards/{{ lang }}/{{ lesson.id }}" class="btn btn-outline-{{ 'french' if lang == 'french' else 'spanish' }}">
              üÉè Flashcards ‚Äî ‡¶´‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶∂‡¶ï‡¶æ‡¶∞‡ßç‡¶°
            </a>
            <a href="{{ url_for('dictation', lang=lang, lesson_id=lesson.id) }}" class="btn btn-outline-{{ 'french' if lang == 'french' else 'spanish' }}">
              üéß Dictation ‚Äî ‡¶∂‡ßÅ‡¶®‡ßÅ‡¶® ‡¶ì ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®
            </a>
            {% endif %}
            <a href="/quiz/{{ lang }}/{{ lesson.id }}" class="btn btn-{{ 'french' if lang == 'french' else 'spanish' }}">
              üß† Take Quiz ‚Äî ‡¶ï‡ßÅ‡¶á‡¶ú ‡¶¶‡¶ø‡¶®
            </a>
          </div>
        </div>

        <!-- Lesson info -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body p-3">
            <div class="info-row">
              <span class="text-muted small">Language</span>
              <span class="fw-semibold">{{ meta.flag }} {{ meta.name }}</span>
            </div>
            <div class="info-row">
              <span class="text-muted small">CEFR Level</span>
              {% set cl = lesson.cefr_level | default('A1') %}
              {% set cefr_labels = {'A1': 'Elementary', 'A2': 'Pre-intermediate', 'B1': 'Intermediate', 'B2': 'Upper Intermediate'} %}
              <span class="badge cefr-{{ cl }}" title="{{ cl }} ‚Äî {{ cefr_labels.get(cl, '') }}">
                {{ cl }} ‚Äî {{ cefr_labels.get(cl, '') }}
              </span>
            </div>
            <div class="info-row">
              <span class="text-muted small">Words</span>
              <span class="fw-semibold">{{ vocabulary | length }}</span>
            </div>
          </div>
        </div>

        <!-- Navigation -->
        <div class="card border-0 shadow-sm">
          <div class="card-body p-3 d-grid gap-2">
            {% if prev_lesson %}
            <a href="/lesson/{{ lang }}/{{ prev_lesson.id }}" class="btn btn-sm btn-outline-secondary">
              ‚Üê {{ prev_lesson.title_en }}
            </a>
            {% endif %}
            <a href="/language/{{ lang }}" class="btn btn-sm btn-outline-secondary">
              ‚ò∞ All {{ meta.name }} Lessons
            </a>
            {% if next_lesson %}
            <a href="/lesson/{{ lang }}/{{ next_lesson.id }}" class="btn btn-sm btn-outline-{{ 'french' if lang == 'french' else 'spanish' }}">
              {{ next_lesson.title_en }} ‚Üí
            </a>
            {% endif %}
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
{% endblock %}
