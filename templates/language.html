{% extends "base.html" %}
{% block title %}{{ meta.name }} Lessons ‚Äî Language Coach{% endblock %}
{% block body_class %}lang-{{ lang }}-page{% endblock %}

{% block content %}
<!-- Language Header -->
<div class="lang-header lang-header-{{ lang }} py-5">
  <div class="container">
    <div class="row align-items-center">
      <div class="col">
        <h1 class="display-4 fw-bold text-white">
          {{ meta.flag }} {{ meta.name }}
          <small class="d-block fs-4 opacity-75">{{ meta.name_bn }} ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ</small>
        </h1>
        <p class="text-white opacity-75 mb-0">
          {{ lessons|length }} lessons &bull; A1 ¬∑ A2 ¬∑ B1 ¬∑ B2 &bull; CEFR Framework
        </p>
      </div>
      <div class="col-auto">
        {% set completed_count = progress.values() | selectattr('completed') | list | length %}
        {% set total = lessons | length %}
        <div class="progress-circle text-center">
          <div class="circle-num text-white fw-bold display-5">{{ completed_count }}</div>
          <div class="text-white opacity-75 small">of {{ total }} done</div>
        </div>
        <div class="mt-3 d-grid gap-2">
          {% if resume_lesson %}
          <a href="{{ url_for('lesson_view', lang=lang, lesson_id=resume_lesson.id) }}" class="btn btn-light btn-sm">
            ‚ñ∂ Resume Lesson {{ resume_lesson.id }}
          </a>
          {% endif %}
          <a href="{{ url_for('practice', lang=lang) }}" class="btn btn-light btn-sm">
            ‚ö° Daily Practice
          </a>
          <a href="{{ url_for('review_flashcards', lang=lang) }}" class="btn btn-outline-light btn-sm">
            <i class="fas fa-repeat me-1"></i> Review
          </a>
          <a href="{{ url_for('vocabulary_view', lang=lang) }}" class="btn btn-outline-light btn-sm">
            <i class="fas fa-book me-1"></i> Vocabulary
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container py-5">
  <!-- CEFR Level sections -->
  {% set level_order = ['A1', 'A2', 'B1', 'B2'] %}
  {% set level_meta = {
    'A1': {
      'label': 'üü¢ A1 ‚Äî Elementary',
      'label_bn': '‡¶™‡ßç‡¶∞‡¶æ‡¶•‡¶Æ‡¶ø‡¶ï',
      'desc': 'Survival basics: greetings, numbers, family, food, daily life, nationalities, hobbies',
      'desc_bn': '‡¶¨‡ßá‡¶Å‡¶ö‡ßá ‡¶•‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶Æ‡ßÇ‡¶≤ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø: ‡¶Ö‡¶≠‡¶ø‡¶¨‡¶æ‡¶¶‡¶®, ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ, ‡¶™‡¶∞‡¶ø‡¶¨‡¶æ‡¶∞, ‡¶ñ‡¶æ‡¶¨‡¶æ‡¶∞, ‡¶¶‡ßà‡¶®‡¶®‡ßç‡¶¶‡¶ø‡¶® ‡¶ú‡ßÄ‡¶¨‡¶®',
      'badge': 'cefr-A1',
      'exam': 'DELF A1 / DELE A1'
    },
    'A2': {
      'label': 'üîµ A2 ‚Äî Pre-intermediate',
      'label_bn': '‡¶™‡ßç‡¶∞‡¶ø-‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶Æ‡¶ø‡¶°‡¶ø‡¶Ø‡¶º‡ßá‡¶ü',
      'desc': 'Expand fluency: past & future tenses, health, work, shopping, emotions, travel',
      'desc_bn': '‡¶¶‡¶ï‡ßç‡¶∑‡¶§‡¶æ ‡¶¨‡¶æ‡¶°‡¶º‡¶æ‡¶®: ‡¶Ö‡¶§‡ßÄ‡¶§ ‡¶ì ‡¶≠‡¶¨‡¶ø‡¶∑‡ßç‡¶Ø‡ßé ‡¶ï‡¶æ‡¶≤, ‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø, ‡¶ï‡¶æ‡¶ú, ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ, ‡¶Ü‡¶¨‡ßá‡¶ó, ‡¶≠‡ßç‡¶∞‡¶Æ‡¶£',
      'badge': 'cefr-A2',
      'exam': 'DELF A2 / DELE A2'
    },
    'B1': {
      'label': 'üü† B1 ‚Äî Intermediate',
      'label_bn': '‡¶Æ‡¶ß‡ßç‡¶Ø‡¶¨‡¶∞‡ßç‡¶§‡ßÄ',
      'desc': 'Build fluency: complex vocabulary, culture, opinions and natural conversation',
      'desc_bn': '‡¶¶‡¶ï‡ßç‡¶∑‡¶§‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®: ‡¶ú‡¶ü‡¶ø‡¶≤ ‡¶∂‡¶¨‡ßç‡¶¶‡¶≠‡¶æ‡¶®‡ßç‡¶°‡¶æ‡¶∞, ‡¶∏‡¶Ç‡¶∏‡ßç‡¶ï‡ßÉ‡¶§‡¶ø, ‡¶Æ‡¶§‡¶æ‡¶Æ‡¶§ ‡¶ì ‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï ‡¶ï‡¶•‡ßã‡¶™‡¶ï‡¶•‡¶®',
      'badge': 'cefr-B1',
      'exam': 'DELF B1 / DELE B1'
    },
    'B2': {
      'label': 'üî¥ B2 ‚Äî Upper Intermediate',
      'label_bn': '‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡¶¨‡¶∞‡ßç‡¶§‡ßÄ',
      'desc': 'Advanced expression: debate, nuance, literature and professional contexts',
      'desc_bn': '‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂‡¶≠‡¶ô‡ßç‡¶ó‡¶ø: ‡¶¨‡¶ø‡¶§‡¶∞‡ßç‡¶ï, ‡¶∏‡ßÇ‡¶ï‡ßç‡¶∑‡ßç‡¶Æ‡¶§‡¶æ, ‡¶∏‡¶æ‡¶π‡¶ø‡¶§‡ßç‡¶Ø ‡¶ì ‡¶™‡ßá‡¶∂‡¶æ‡¶¶‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßá‡¶ï‡ßç‡¶∑‡¶æ‡¶™‡¶ü',
      'badge': 'cefr-B2',
      'exam': 'DELF B2 / DELE B2'
    }
  } %}

  {% for lvl in level_order %}
  {% set lvl_lessons = lessons | selectattr('cefr_level', 'equalto', lvl) | list | sort(attribute='id') %}
  {% if lvl_lessons %}
  {% set lm = level_meta[lvl] %}
  <div class="level-section mb-5">
    <div class="level-header mb-4 d-flex align-items-start gap-3 flex-wrap">
      <div>
        <h2 class="fw-bold mb-1">{{ lm.label }}
          <span class="badge {{ lm.badge }} ms-2 fs-6 align-middle">{{ lvl }}</span>
        </h2>
        <p class="text-muted mb-1">{{ lm.desc }}</p>
        <small class="text-muted fst-italic">{{ lm.desc_bn }}</small>
        <div class="mt-1">
          <span class="badge bg-light text-dark border small">{{ lm.exam }}</span>
          <span class="badge bg-light text-muted border small ms-1">{{ lvl_lessons|length }} lessons</span>
        </div>
      </div>
    </div>
    <div class="row g-3">
      {% for lesson in lvl_lessons %}
      {% set prog = progress.get(lesson.id, {}) %}
      {% set is_done = prog.get('completed', 0) %}
      <div class="col-md-6 col-lg-4">
        <div class="lesson-card card h-100 {% if is_done %}lesson-done{% endif %}">
          <div class="card-body p-4">
            <div class="d-flex align-items-start gap-3">
              <div class="lesson-icon-wrap">
                <span class="lesson-icon">{{ lesson.icon }}</span>
                {% if is_done %}
                <span class="done-badge"><i class="fas fa-check"></i></span>
                {% endif %}
              </div>
              <div class="flex-grow-1 min-w-0">
                <div class="d-flex align-items-center gap-1 mb-1">
                  <span class="lesson-num text-muted small">Lesson {{ lesson.id }}</span>
                  <span class="badge {{ lm.badge }} ms-1" style="font-size:0.6rem; padding:2px 5px;">{{ lvl }}</span>
                </div>
                <h5 class="card-title mb-1 fw-semibold">{{ lesson.title_en }}</h5>
                <p class="card-subtitle text-muted small mb-2">{{ lesson.title_bn }}</p>
                <p class="card-text small text-muted">{{ lesson.description_en[:85] }}{% if lesson.description_en|length > 85 %}‚Ä¶{% endif %}</p>
                {% if is_done and prog.get('best_score', 0) > 0 %}
                <div class="score-badge mt-2">
                  <i class="fas fa-star text-warning"></i>
                  Best score: {{ prog.best_score }}%
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="card-footer bg-transparent border-0 p-3 pt-0">
            <a href="/lesson/{{ lang }}/{{ lesson.id }}" class="btn btn-{{ 'french' if lang == 'french' else 'spanish' }} btn-sm w-100">
              {{ '‚úî Review' if is_done else '‚ñ∂ Start Lesson' }}
            </a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
  {% endfor %}
</div>
{% endblock %}
