<div class="card border-0 shadow-sm mb-4 lesson-activity lesson-activity-numbers">
  <div class="card-body p-4">
    <h3 class="section-label mb-3">
      <i class="fas fa-hashtag me-2 text-{{ 'french' if lang == 'french' else 'spanish' }}"></i>
      Numbers Trainer (0‚Äì1000) ‚Äî ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶∂‡ßÄ‡¶≤‡¶®
    </h3>
    <p class="text-muted small mb-3">
      Convert any number to words, listen to the pronunciation, and practise spelling.
    </p>

    <div class="row g-3 align-items-end mb-4">
      <div class="col-md-4">
        <label class="form-label small text-muted mb-1">Number (0‚Äì1000)</label>
        <input id="lcNumsInput" type="number" class="form-control" min="0" max="1000" step="1" value="21">
      </div>
      <div class="col-md-4 d-grid">
        <button id="lcNumsConvert" type="button"
                class="btn btn-{{ 'french' if lang == 'french' else 'spanish' }}">
          Convert
        </button>
      </div>
      <div class="col-md-4 d-grid">
        <button id="lcNumsSpeak" type="button"
                class="btn btn-outline-{{ 'french' if lang == 'french' else 'spanish' }}">
          üîä Listen
        </button>
      </div>
      <div class="col-12">
        <div id="lcNumsOutput" class="fw-semibold fs-5"></div>
        <div id="lcNumsHint" class="small text-muted"></div>
      </div>
    </div>

    <div class="border rounded-3 p-3 p-md-4 bg-light">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div class="fw-semibold">Quick Practice</div>
        <div class="small text-muted" id="lcNumsScore">0 correct ‚Ä¢ 0 wrong</div>
      </div>

      <div class="mt-3">
        <div class="display-6 fw-bold" id="lcNumsQuizN">‚Äî</div>
        <div class="small text-muted mt-1">
          Type it in {{ meta.name_native or meta.name }} (spaces/hyphens both accepted).
        </div>
      </div>

      <div class="row g-2 align-items-end mt-2">
        <div class="col-md-8">
          <input id="lcNumsAnswer" type="text" class="form-control"
                 placeholder="Type the number in words‚Ä¶"
                 autocomplete="off" spellcheck="false">
        </div>
        <div class="col-md-4 d-grid">
          <button id="lcNumsCheck" type="button" class="btn btn-outline-secondary">Check</button>
        </div>
        <div class="col-12">
          <div id="lcNumsFeedback" class="small mt-2"></div>
        </div>
      </div>

      <div class="d-flex gap-2 flex-wrap mt-3">
        <button id="lcNumsQuizSpeak" type="button" class="btn btn-light border">üîä Listen</button>
        <button id="lcNumsReveal" type="button" class="btn btn-light border">Show Answer</button>
        <button id="lcNumsNext" type="button"
                class="btn btn-{{ 'french' if lang == 'french' else 'spanish' }}">
          Next
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const lang = '{{ lang }}';
  const ttsLang = lang === 'french' ? 'fr-FR' : 'es-ES';

  const $ = (id) => document.getElementById(id);
  const elInput = $('lcNumsInput');
  const elConvert = $('lcNumsConvert');
  const elSpeak = $('lcNumsSpeak');
  const elOut = $('lcNumsOutput');
  const elHint = $('lcNumsHint');

  const elQuizN = $('lcNumsQuizN');
  const elAnswer = $('lcNumsAnswer');
  const elCheck = $('lcNumsCheck');
  const elFeedback = $('lcNumsFeedback');
  const elScore = $('lcNumsScore');
  const elQuizSpeak = $('lcNumsQuizSpeak');
  const elReveal = $('lcNumsReveal');
  const elNext = $('lcNumsNext');

  if (!elInput || !elConvert || !elSpeak || !elOut || !elQuizN || !elAnswer) return;

  function stripDiacritics(s) {
    try {
      return String(s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    } catch {
      return String(s || '');
    }
  }

  function normWords(s) {
    return stripDiacritics(String(s || '').toLowerCase())
      .replace(/[‚Äô']/g, ' ')
      .replace(/-/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();
  }

  // -------- French numbers --------
  const frUnits = ['z√©ro','un','deux','trois','quatre','cinq','six','sept','huit','neuf'];
  const frTeens = {
    10: 'dix', 11: 'onze', 12: 'douze', 13: 'treize', 14: 'quatorze',
    15: 'quinze', 16: 'seize', 17: 'dix-sept', 18: 'dix-huit', 19: 'dix-neuf',
  };
  const frTens = {20: 'vingt', 30: 'trente', 40: 'quarante', 50: 'cinquante', 60: 'soixante'};

  function frBelow100(n) {
    if (n < 10) return frUnits[n];
    if (n < 20) return frTeens[n];
    if (n < 70) {
      const t = Math.floor(n / 10) * 10;
      const u = n % 10;
      if (u === 0) return frTens[t];
      if (u === 1) return `${frTens[t]}-et-un`;
      return `${frTens[t]}-${frUnits[u]}`;
    }
    if (n < 80) {
      const base = 'soixante';
      const rest = n - 60; // 10..19
      if (rest === 11) return `${base}-et-onze`; // 71 special
      return `${base}-${frBelow100(rest)}`;
    }
    const base = 'quatre-vingt';
    const rest = n - 80;
    if (rest === 0) return 'quatre-vingts';
    return `${base}-${frBelow100(rest)}`;
  }

  function toWordsFr(n) {
    if (n === 0) return 'z√©ro';
    if (n === 1000) return 'mille';
    if (n < 100) return frBelow100(n);

    const hundreds = Math.floor(n / 100);
    const rest = n % 100;

    let head = '';
    if (hundreds === 1) head = 'cent';
    else head = `${frBelow100(hundreds)} cent`;

    if (rest === 0 && hundreds > 1) head += 's';
    if (rest === 0) return head;
    return `${head} ${frBelow100(rest)}`;
  }

  // -------- Spanish numbers --------
  const esUnits = ['cero','uno','dos','tres','cuatro','cinco','seis','siete','ocho','nueve'];
  const esTeens = {
    10: 'diez', 11: 'once', 12: 'doce', 13: 'trece', 14: 'catorce',
    15: 'quince', 16: 'diecis√©is', 17: 'diecisiete', 18: 'dieciocho', 19: 'diecinueve',
  };
  const esTens = {20: 'veinte', 30: 'treinta', 40: 'cuarenta', 50: 'cincuenta', 60: 'sesenta', 70: 'setenta', 80: 'ochenta', 90: 'noventa'};
  const esHundreds = {
    100: 'cien', 200: 'doscientos', 300: 'trescientos', 400: 'cuatrocientos',
    500: 'quinientos', 600: 'seiscientos', 700: 'setecientos', 800: 'ochocientos', 900: 'novecientos',
  };

  function esBelow100(n) {
    if (n < 10) return esUnits[n];
    if (n < 20) return esTeens[n];
    if (n < 30) {
      if (n === 20) return 'veinte';
      const s = {22:'veintid√≥s', 23:'veintitr√©s', 26:'veintis√©is'}[n];
      if (s) return s;
      return `veinti${esUnits[n - 20]}`;
    }
    const t = Math.floor(n / 10) * 10;
    const u = n % 10;
    if (u === 0) return esTens[t];
    return `${esTens[t]} y ${esUnits[u]}`;
  }

  function toWordsEs(n) {
    if (n === 1000) return 'mil';
    if (n < 100) return esBelow100(n);
    if (n === 100) return 'cien';

    const hundreds = Math.floor(n / 100) * 100; // 100..900
    const rest = n % 100;

    let head = '';
    if (hundreds === 100) head = 'ciento';
    else head = esHundreds[hundreds] || '';

    if (!rest) return head;
    return `${head} ${esBelow100(rest)}`;
  }

  function toWords(n) {
    if (n < 0 || n > 1000 || !Number.isFinite(n)) return '';
    n = Math.trunc(n);
    return lang === 'french' ? toWordsFr(n) : toWordsEs(n);
  }

  function expectedSet(n) {
    const base = toWords(n);
    const set = new Set();
    if (!base) return set;
    set.add(normWords(base));

    if (lang === 'french') {
      set.add(normWords(base.replace(/-et-/g, '-'))); // accept missing "et"
      set.add(normWords(base.replace(/\bquatre-vingts\b/g, 'quatre-vingt'))); // accept missing plural s
      set.add(normWords(base.replace(/\bcents\b/g, 'cent'))); // accept missing plural s
      set.add(normWords(base.replace(/\bsoixante-et-onze\b/g, 'soixante-onze'))); // common variant
    } else {
      if (n === 100) set.add(normWords('ciento')); // common learner mistake; be lenient
    }
    return set;
  }

  function setOutput(n) {
    const w = toWords(n);
    elOut.textContent = w ? w : '';
    elHint.textContent = w ? `Example: ${n} ‚Üí ${w}` : '';
    return w;
  }

  function parseInputNumber() {
    const n = Number(elInput.value);
    if (!Number.isFinite(n)) return null;
    const nn = Math.trunc(n);
    if (nn < 0 || nn > 1000) return null;
    return nn;
  }

  elConvert.addEventListener('click', () => {
    const n = parseInputNumber();
    if (n === null) {
      elOut.textContent = '';
      elHint.textContent = 'Please enter a number between 0 and 1000.';
      return;
    }
    setOutput(n);
  });

  elSpeak.addEventListener('click', () => {
    const n = parseInputNumber();
    if (n === null) return;
    const w = setOutput(n);
    if (w) speakText(w, ttsLang);
  });

  // -------- Quiz --------
  let quizN = 0;
  let correct = 0;
  let wrong = 0;
  let lastReveal = '';

  function updateScore() {
    elScore.textContent = `${correct} correct ‚Ä¢ ${wrong} wrong`;
  }

  function newQuiz() {
    quizN = Math.floor(Math.random() * 1001);
    elQuizN.textContent = String(quizN);
    elAnswer.value = '';
    elFeedback.textContent = '';
    lastReveal = '';
  }

  function reveal() {
    const w = toWords(quizN);
    lastReveal = w;
    elFeedback.innerHTML = `<span class="text-muted">Answer:</span> <strong>${escapeHtml(w)}</strong>`;
  }

  function check() {
    const want = expectedSet(quizN);
    const got = normWords(elAnswer.value);
    if (!got) return;

    if (want.has(got)) {
      correct += 1;
      updateScore();
      elFeedback.innerHTML = `<span class="text-success fw-semibold">Correct!</span>`;
    } else {
      wrong += 1;
      updateScore();
      const w = toWords(quizN);
      elFeedback.innerHTML = `<span class="text-danger fw-semibold">Not quite.</span> <span class="text-muted">Correct:</span> <strong>${escapeHtml(w)}</strong>`;
    }
  }

  elCheck.addEventListener('click', check);
  elAnswer.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      check();
    }
  });

  elReveal.addEventListener('click', reveal);
  elNext.addEventListener('click', newQuiz);
  elQuizSpeak.addEventListener('click', () => {
    const w = lastReveal || toWords(quizN);
    if (w) speakText(w, ttsLang);
  });

  // initial state
  setOutput(parseInputNumber() ?? 21);
  updateScore();
  newQuiz();
})();
</script>

