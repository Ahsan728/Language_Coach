{% extends "base.html" %}
{% block title %}Flashcards ‚Äî {{ lesson.title_en }}{% endblock %}
{% block body_class %}lang-{{ lang }}-page flashcard-page{% endblock %}

{% block content %}
<div class="lang-header lang-header-{{ lang }} py-4">
  <div class="container">
    <div class="d-flex align-items-center gap-3">
      {% set fallback_back = url_for('lesson_view', lang=lang, lesson_id=lesson.id) if lesson.id else url_for('language_home', lang=lang) %}
      <a href="{{ back_url or fallback_back }}" class="btn btn-sm btn-light btn-back">
        ‚Üê Back
      </a>
      <div>
        <h2 class="text-white fw-bold mb-0">üÉè Flashcards ‚Äî ‡¶´‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶∂‡¶ï‡¶æ‡¶∞‡ßç‡¶°</h2>
        <p class="text-white opacity-75 mb-0">
          {{ lesson.title_en }}{% if lesson.title_bn %} ‚Ä¢ {{ lesson.title_bn }}{% endif %}
          {% if header_subtitle %}<br><small>{{ header_subtitle }}</small>{% endif %}
        </p>
      </div>
    </div>
  </div>
</div>

{% if not vocabulary %}
<div class="container py-5">
  <div class="alert alert-warning text-center">
    <h4 class="mb-2">‚ö†Ô∏è No vocabulary found</h4>
    <p class="text-muted mb-3">This set is empty right now.</p>
    <a href="{{ back_url or fallback_back }}" class="btn btn-secondary">‚Üê Back</a>
  </div>
</div>
{% else %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-6 col-md-8">

      <!-- Progress -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <span class="text-muted small" id="cardCounter">Card 1 of {{ vocabulary | length }}</span>
        <div class="d-flex gap-2">
          <span class="badge bg-success" id="knownCount">‚úì 0 Known</span>
          <span class="badge bg-danger" id="unknownCount">‚úó 0 Review</span>
        </div>
      </div>
      <div class="progress mb-4" style="height:8px">
        <div class="progress-bar bg-{{ 'french' if lang == 'french' else 'spanish' }}" id="flashProgress" style="width:0%"></div>
      </div>

      <!-- The Card -->
      <div class="flashcard-container" id="flashcardContainer">
        <div class="flashcard" id="flashcard" onclick="flipCard()">
          <div class="flashcard-front">
            <div class="card-lang-tag">{{ meta.flag }} {{ meta.name }}</div>
            <div class="flashcard-word" id="cardWord">Loading...</div>
            <div class="flashcard-pron" id="cardPron"></div>
            <div class="flip-hint mt-4 text-muted small">
              <i class="fas fa-hand-pointer"></i> Click to reveal translation
              <br><small class="bengali-text">‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá</small>
            </div>
          </div>
          <div class="flashcard-back">
            <div class="back-row">
              <span class="back-flag">üá¨üáß</span>
              <span class="back-english" id="cardEnglish"></span>
            </div>
            <div class="back-row">
              <span class="back-flag">üáßüá©</span>
              <span class="back-bengali bengali-text" id="cardBengali"></span>
            </div>
            <div class="back-example" id="cardExample"></div>
          </div>
        </div>
      </div>

      <!-- Answer buttons (shown after flip) -->
      <div class="flashcard-actions mt-4" id="flashActions" style="display:none">
        <div class="row g-2">
          <div class="col-6">
            <button class="btn btn-outline-danger w-100" onclick="markCard(false)">
              <i class="fas fa-times me-1"></i> Need Review
              <small class="d-block bengali-text">‡¶Ü‡¶∞‡¶ì ‡¶™‡¶°‡¶º‡¶§‡ßá ‡¶π‡¶¨‡ßá</small>
            </button>
          </div>
          <div class="col-6">
            <button class="btn btn-success w-100" onclick="markCard(true)">
              <i class="fas fa-check me-1"></i> I Know It!
              <small class="d-block bengali-text">‡¶ú‡¶æ‡¶®‡¶ø!</small>
            </button>
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <div class="d-flex justify-content-between mt-4">
        <button class="btn btn-outline-secondary" onclick="prevCard()" id="prevBtn" disabled>
          ‚Üê Previous
        </button>
        <div class="text-center d-flex gap-2">
          <button class="btn btn-light" type="button" onclick="listenFlashcard()">
            <i class="fas fa-volume-up"></i> Listen
          </button>
          <button class="btn btn-light" onclick="shuffleCards()">
            <i class="fas fa-random"></i> Shuffle
          </button>
        </div>
        <button class="btn btn-outline-{{ 'french' if lang == 'french' else 'spanish' }}" onclick="nextCard()" id="nextBtn">
          Next ‚Üí
        </button>
      </div>

      <!-- Completion message -->
      <div class="completion-box mt-4 text-center" id="completionBox" style="display:none">
        <div class="fs-1">üéâ</div>
        <h4 class="mt-2">‡¶¶‡¶æ‡¶∞‡ßÅ‡¶£! ‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡¶¨ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡ßá‡¶õ‡ßá‡¶®!</h4>
        <p class="text-muted">Great job reviewing all {{ vocabulary | length }} flashcards!</p>
        <div class="d-flex gap-2 justify-content-center mt-3">
          <button class="btn btn-outline-secondary" onclick="restartCards()">‚Ü∫ Restart</button>
          {% if show_quiz_link %}
          <a href="{{ url_for('quiz', lang=lang, lesson_id=lesson.id) }}" class="btn btn-{{ 'french' if lang == 'french' else 'spanish' }}">
            Take Quiz üß†
          </a>
          {% else %}
          <a href="{{ back_url or fallback_back }}" class="btn btn-{{ 'french' if lang == 'french' else 'spanish' }}">
            Back to Lessons
          </a>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</div>
{% endif %}

<script>
const VOCAB = {{ vocab_json | safe }};
const LANG  = '{{ lang }}';
const LESSON_ID = {{ lesson.id }};
</script>
{% endblock %}
